<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>swagio</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.bundle.min.js"></script>
  <style>
    body,
    html {
      width: 100%;
      height: 100%;
      padding: 0;
      margin: 0;
    }

    .chart-container {
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100%;
    }

    .chart-container .chart {
      flex: 1;
      display: relative;
    }

    .chart .controls {
      position: relative;
      top: -100%;
      margin-bottom: -25px;
      left: 0%;
      margin-left: 0px;
    }

    #barChart {}

    #lineChart {}

    #disconnectedMessage {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      width: 400px;
      margin-left: -200px;
      margin-top: -200px;
      padding: 24px;
      box-shadow: 0 0 0 5000px rgba(0, 0, 0, 0.4);
      background: white;
    }

    .display {
      font-weight: bold;
    }
  </style>
</head>

<body>
  <div class="chart-container">
    <div class="chart">
      <canvas id="barChart"></canvas>
    </div>
    <div class="chart">
      <canvas id="lineChart"></canvas>
      <div class="controls">
        <button class="change-sample-count" onclick="changeSampleCount(+500)">+500</button>
        <button class="change-sample-count" onclick="changeSampleCount(+100)">+100</button>
        <button class="change-sample-count" onclick="changeSampleCount(+20)">+20</button>
        <button class="change-sample-count" onclick="changeSampleCount(+5)">+5</button>
        <button class="change-sample-count" onclick="changeSampleCount(+1)">+1</button>
        <button disabled="disabled" class="sample-count-display"></button>
        <button class="change-sample-count" onclick="changeSampleCount(-1)">-1</button>
        <button class="change-sample-count" onclick="changeSampleCount(-5)">-5</button>
        <button class="change-sample-count" onclick="changeSampleCount(-20)">-20</button>
        <button class="change-sample-count" onclick="changeSampleCount(-100)">-100</button>
        <button class="change-sample-count" onclick="changeSampleCount(-500)">-500</button>
      </div>
    </div>
  </div>

  <div id="disconnectedMessage">
    <h2>No connection</h2>
    <p>We don't have a WebSocket connection to the swagio intermediary.</p>
    <p>Please double-check that
      <ul>
        <li>the swagio intermediary is running on <span class="host-display display"></span></li>
        <li>the swagio intermediary also is configured to run on port <span class="port-display display"></span></li>
    </p>
  </div>

  <script>
    Chart.defaults.global.animation.duration = 100

    var ctxBar = document.getElementById("barChart")
    var barChart = new Chart(ctxBar, {
      type: 'bar',
      data: {
        labels: [],
        datasets: [{
          label: 'Pin state (digital) or voltage (analog)',
          data: [],
          borderWidth: 1,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          yAxes: [{
            ticks: {
              beginAtZero: true,
              suggestedMax: 5.0
            }
          }]
        }
      }
    })

    var ctxLine = document.getElementById("lineChart")
    var lineChart = new Chart(ctxLine, {
      type: 'line',
      data: {
        datasets: [{
          label: 'Pin state (digital) or voltage (analog) over time',
          data: [],
          borderWidth: 1,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          yAxes: [{
            ticks: {
              beginAtZero: true
            }
          }]
        }
      }
    })

    /**
     * TODO: make port (and maybe host) configurable
     */
    var host = location.host
    var port = 53491
    var lineChartSampleCount = 200
    var barChartEnable = false
    var lineChartEnable = true

    var sampleCounterMod = 0

    /**
     * This will have our WebSocket
     * @type {WebSocket}
     * @see connectionDoctor
     */
    window.ws = null

    var disconnectedMessage = document.getElementById("disconnectedMessage")
    var doctorIntervalMs = 500
    setInterval(connectionDoctor, doctorIntervalMs)

    setInterval(function() {
      display("sample-count-display", lineChartSampleCount)
      //if (barChartEnable) barChart.update()
      //if(lineChartEnable) lineChart.update()
    }, 50)

    /**
     * Update our chart when we receive a message
     * @param  {MessageEvent} message
     */
    function onWsMessage(message) {
      let pinData = JSON.parse(message.data)
      let pinNames = Object.keys(pinData)
      let pinValues = Object.values(pinData)

      if (barChartEnable) {
        /**
         * Update chart labels and data pints
         */
        barChart.config.data.labels = pinNames
        barChart.config.data.datasets[0].data = pinValues

        /**
         * Colorize each of the bars according to the kind of pin it represents
         */
        barChart.config.data.datasets[0].backgroundColor =
          pinNames.map(pin => (pin.charAt(0) == "D") ? 'rgba(127, 50, 67, 0.2)' : 'rgba(50, 67, 127, 0.2)')
        barChart.config.data.datasets[0].borderColor =
          pinNames.map(pin => (pin.charAt(0) == "D") ? 'rgba(127, 50, 67, 0.2)' : 'rgba(50, 67, 127, 0.2)')

        /**
         * This one's important; here we trigger a re-render of our chart
         */
        barChart.update()
      }

      /**
       * Update line chart
       */
      while (lineChart.config.data.datasets[0].data.length > lineChartSampleCount) {
        lineChart.config.data.labels.pop()
        lineChart.config.data.datasets[0].data.pop()
      }
      if (lineChart.config.data.datasets[0].data.length < lineChartSampleCount) {
        while (lineChart.config.data.datasets[0].data.length < lineChartSampleCount) {
          lineChart.config.data.labels.push("")
          lineChart.config.data.datasets[0].data.push(pinData.A0)
        }
      } else {
        lineChart.config.data.datasets[0].data[sampleCounterMod] = pinData.A0
      }
      sampleCounterMod = (sampleCounterMod + 1) % lineChartSampleCount

      /**
       * This one's important; here we trigger a re-render of our chart
       */
      if (sampleCounterMod == 0) lineChart.update()
    }

    /**
     * Called periodically to monitor the WebSocket's health
     */
    function connectionDoctor() {
      if (!ws || ws.readyState != WebSocket.OPEN) {
        /**
         * Try to connect to the intermediary
         * @type {WebSocket}
         */
        ws = new WebSocket("ws://" + host + ":" + port)
        /**
         * Make sure the right message handler is on
         * @see onWsMessage
         */
        ws.onmessage = onWsMessage
      }
      /**
       * Do a short delay here to give ws some time to establish its connection
       * before be show the disconnected message
       */
      setTimeout(function() {
        if (ws.readyState != WebSocket.OPEN) {
          /**
           * Update the message to reflect our host/port settings
           */
          display("host-display", host)
          display("port-display", port)
          /**
           * Show the disconnected message
           */
          disconnectedMessage.style.display = "block"
        } else {
          /**
           * All is good; hide the disconnected message
           */
          disconnectedMessage.style.display = "none"
        }
      }, doctorIntervalMs / 2)
    }

    function changeSampleCount(delta) {
      lineChartSampleCount += delta
      lineChartSampleCount = Math.max(5, lineChartSampleCount)
      display("sample-count-display", lineChartSampleCount)
    }

    function display(className, text) {
      let es = document.getElementsByClassName(className)
      if (es) {
        for (var i = 0; i < es.length; i++) {
          es[i].innerText = text
        }
      }
    }
  </script>
</body>

</html>
